---
sidebar: sidebar 
permalink: task-tiering.html 
keywords: tier, tiering, cold data, hot data, storage tiering, data tiering, S3 tiering, fabricpool, fabric pool, s3 endpoint, endpoint, connection, performance tier, capacity tier, object store, azure tiering, blob tiering, azure blob, container, inactive, gcp, tiering in gcp, tiering requirements 
summary: 通过将热数据的 SSD 或 HDD 性能层与非活动数据的对象存储容量层相结合，您可以降低 Cloud Volumes ONTAP 的存储成本。数据分层由 FabricPool 技术提供支持。 
---
= 将非活动数据分层到低成本对象存储
:hardbreaks:
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
通过将热数据的 SSD 或 HDD 性能层与非活动数据的对象存储容量层相结合，您可以降低 Cloud Volumes ONTAP 的存储成本。数据分层由 FabricPool 技术提供支持。有关简要概述，请参见 link:concept-data-tiering.html["数据分层概述"]。

要设置数据分层，您需要执行以下操作：

[role="quick-margin-para"]
支持大多数配置。如果您的 Cloud Volumes ONTAP 系统运行的是最新版本，则最好继续操作。 link:task-tiering.html#configurations-that-support-data-tiering["了解更多信息。"]。

.跨度 class="image><img src="https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-2.png"[] Alt+twe"></span> 确保 Cloud Volumes ONTAP 与对象存储之间的连接
* 对于 AWS ， S3 需要一个 VPC 端点。 <<Requirements to tier cold data to AWS S3,了解更多信息。>>。
* 对于 Azure ，只要 Cloud Manager 具有所需权限，您就无需执行任何操作。 <<Requirements to tier cold data to Azure Blob storage,了解更多信息。>>。
* 对于 GCP ，您需要为 Private Google Access 配置子网并设置服务帐户。 <<Requirements to tier cold data to a Google Cloud Storage bucket,了解更多信息。>>。


[role="quick-margin-para"]
必须在聚合上启用数据分层，才能在卷上启用数据分层。您应了解新卷和现有卷的要求。 <<Ensuring that tiering is enabled on aggregates,了解更多信息。>>。

[role="quick-margin-para"]
在创建，修改或复制卷时， Cloud Manager 会提示您选择分层策略。

* link:task-tiering.html#tiering-data-from-read-write-volumes["对读写卷上的数据进行分层"]
* link:task-tiering.html#tiering-data-from-data-protection-volumes["分层数据保护卷上的数据"]


[NOTE]
.数据分层不需要什么？
====
* 您无需安装功能许可证即可启用数据分层。
* 您无需创建容量层（ S3 存储分段， Azure Blob 容器或 GCP 存储分段）。云管理器可以为您提供这种功能。
* 您无需在系统级别启用数据分层。
+
Cloud Manager 会在创建系统时为冷数据创建一个对象存储， <<Enabling data tiering after implementing the requirements,只要没有连接或权限问题>>。之后，您只需在卷上启用数据分层（在某些情况下， <<Ensuring that tiering is enabled on aggregates,在聚合上>>）。



====


== 支持数据分层的配置

您可以在使用特定配置和功能时启用数据分层：

* 从以下版本开始， Cloud Volumes ONTAP 支持数据分层：
+
** AWS 中的 9.2 版
** 采用单节点系统的 Azure 中的 9.4 版
** 使用 HA 对的 Azure 中的 9.6 版
** GCP 中的 9.6 版


* 在 AWS 中，性能层可以是通用 SSD （ GP3 或 GP2 ）或配置的 IOPS SSD （ IO1 ）。
+

NOTE: 使用吞吐量优化型 HDD （ st1 ）时，不建议将数据分层到对象存储。

* 在 Azure 中，性能层可以是高级 SSD 受管磁盘，标准 SSD 受管磁盘或标准 HDD 受管磁盘。
* 在 GCP 中，性能层可以是 SSD 永久性磁盘，平衡永久性磁盘或标准永久性磁盘。
* 加密技术支持数据分层。
* 必须在卷上启用精简配置。




== 要求

根据您的云提供商，必须设置某些连接和权限，以便 Cloud Volumes ONTAP 可以将冷数据分层到对象存储。



=== 将冷数据分层到 AWS S3 的要求

确保 Cloud Volumes ONTAP 已连接到 S3 。提供该连接的最佳方法是创建到 S3 服务的 VPC 端点。有关说明，请参见 https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpce-gateway.html#create-gateway-endpoint["AWS 文档：创建网关端点"^]。

创建 VPC 端点时，请确保选择与 Cloud Volumes ONTAP 实例对应的区域、 VPC 和路由表。您还必须修改安全组才能添加出站 HTTPS 规则、该规则允许通信到 S3 端点。否则， Cloud Volumes ONTAP 无法连接到 S3 服务。

如果遇到任何问题，请参见 https://aws.amazon.com/premiumsupport/knowledge-center/connect-s3-vpc-endpoint/["AWS 支持知识中心：为什么我无法使用网关 VPC 端点连接到 S3 存储分段？"^]。



=== 将冷数据分层到 Azure Blob 存储的要求

只要 Cloud Manager 具有所需权限，您就无需在性能层和容量层之间设置连接。如果 Cloud Manager 策略具有以下权限，则 Cloud Manager 将为您启用 vNet 服务端点：

[source, json]
----
"Microsoft.Network/virtualNetworks/subnets/write",
"Microsoft.Network/routeTables/join/action",
----
权限包含在最新版本中 https://mysupport.netapp.com/site/info/cloud-manager-policies["Cloud Manager 策略"]。



=== 将冷数据分层到 Google Cloud 存储分段的要求

* 必须为 Cloud Volumes ONTAP 所在的子网配置专用 Google 访问。有关说明，请参见 https://cloud.google.com/vpc/docs/configure-private-google-access["Google Cloud 文档：配置私有 Google Access"^]。
* 您需要满足以下要求的服务帐户：
+
** 它必须具有预定义的存储管理员角色。
** Connector 服务帐户必须是此分层服务帐户的 _Service Account User_ 。
+
link:task-creating-gcp-service-account.html["了解如何设置服务帐户"]。

** 要使用客户管理的加密密钥对存储分段进行加密，请启用 Google Cloud 存储分段以使用此密钥。
+
link:task-setting-up-gcp-encryption.html["了解如何在 Cloud Volumes ONTAP 中使用客户管理的加密密钥"]。







=== 在实施要求后启用数据分层

Cloud Manager 会在创建系统时为冷数据创建一个对象存储，前提是不存在连接或权限问题。如果在创建系统之前未实施上述要求，则需要手动启用分层，从而创建对象存储。

.步骤
. <<Requirements,确保满足所有要求>>。
. 在 " 画布 " 页面上，双击 Cloud Volumes ONTAP 实例的名称。
. 单击菜单图标并选择 * 启用容量分层 * 。
+
image:screenshot_enable_capacity_tiering.gif["如果在 Cloud Manager 尝试启用数据分层时遇到问题描述，则可从工作环境菜单中查看启用容量分层选项的屏幕截图。"]

+

NOTE: 只有在 Cloud Manager 创建系统时无法启用数据分层时，您才会看到此选项。

. 单击 * 启用 * ，以便 Cloud Manager 可以创建此 Cloud Volumes ONTAP 系统将用于分层数据的对象存储。




== 确保在聚合上启用分层

必须在聚合上启用数据分层，才能在卷上启用数据分层。您应了解新卷和现有卷的要求。

* * 新卷 *
+
如果要在新卷上启用数据分层，则无需担心在聚合上启用数据分层。Cloud Manager 会在已启用分层的现有聚合上创建卷，或者如果尚未存在已启用数据分层的聚合，则它会为卷创建新聚合。

* * 现有卷 *
+
如果要在现有卷上启用数据分层，则需要确保在底层聚合上启用数据分层。如果现有聚合未启用数据分层，则需要使用 System Manager 将现有聚合附加到对象存储。



.确认是否已在聚合上启用分层的步骤
. 在 Cloud Manager 中打开工作环境。
. 单击菜单图标，单击 * 高级 * ，然后单击 * 高级分配 * 。
. 验证是否已在聚合上启用分层。
+
image:screenshot_aggr_tiering.gif["显示 Cloud Manager 中包含分层状态的聚合信息的屏幕截图。"]



.在聚合上启用分层的步骤
. 在 System Manager 中，单击 * 存储 > 层 * 。
. 单击聚合的操作菜单并选择 * 附加云层 * 。
. 选择要附加的云层，然后单击 * 保存 * 。


现在，您可以在新卷和现有卷上启用数据分层，如下一节所述。



== 对读写卷中的数据进行分层

Cloud Volumes ONTAP 可以将读写卷上的非活动数据分层到经济高效的对象存储中，从而腾出性能层来存储热数据。

.步骤
. 在工作环境中、创建新卷或更改现有卷的层：
+
[cols="30,70"]
|===
| 任务 | Action 


| 创建新卷 | 单击 * 添加新卷 * 。 


| 修改现有卷 | 选择卷并单击 * 更改磁盘类型和分层策略 * 。 
|===
. 选择分层策略。
+
有关这些策略的问题描述，请参见 link:concept-data-tiering.html["数据分层概述"]。

+
* 示例 *

+
image:screenshot_tiered_storage.gif["屏幕快照，显示了启用对对象存储分层的图标。"]

+
如果启用数据分层的聚合尚未存在，则 Cloud Manager 会为该卷创建一个新聚合。





== 对数据保护卷中的数据进行分层

Cloud Volumes ONTAP 可以将数据从数据保护卷分层到容量层。如果激活目标卷、则数据将在读取时逐渐移动到性能层。

.步骤
. 在 " 画布 " 页面上，选择包含源卷的工作环境，然后将其拖动到要将该卷复制到的工作环境。
. 按照提示操作、直至到达分层页面并启用到对象存储的数据分层。
+
* 示例 *

+
image:screenshot_replication_tiering.gif["复制卷时显示 S3 分层选项的屏幕快照。"]

+
有关复制数据的帮助，请参见 https://docs.netapp.com/us-en/cloud-manager-replication/task-replicating-data.html["将数据复制到云中或从云中复制数据"^]。





== 更改分层数据的存储类

部署 Cloud Volumes ONTAP 后，您可以通过更改 30 天内未访问的非活动数据的存储类来降低存储成本。如果您确实访问数据，访问成本会更高，因此在更改存储类之前，必须考虑到这一点。

分层数据的存储类在系统范围内—不是每个卷的 ​it 。

有关支持的存储类的信息，请参见 link:concept-data-tiering.html["数据分层概述"]。

.步骤
. 在工作环境中，单击菜单图标，然后单击 * 存储类 * 或 * Blob 存储分层 * 。
. 选择一个存储类，然后单击 * 保存 * 。




== 更改数据分层的可用空间比率

数据分层的可用空间比率用于定义将数据分层到对象存储时， Cloud Volumes ONTAP SSD/HDD 上需要多少可用空间。默认设置为 10% 的可用空间，但您可以根据需要调整此设置。

例如，您可以选择小于 10% 的可用空间，以确保您正在利用所购买的容量。然后， Cloud Manager 可以在需要额外容量时为您购买额外磁盘（直到达到聚合的磁盘限制为止）。


CAUTION: 如果空间不足，则 Cloud Volumes ONTAP 无法移动数据，并且可能会出现性能下降。任何更改都应谨慎进行。如果您不确定，请联系 NetApp 支持部门以获得指导。

此比率对于灾难恢复场景非常重要，因为从对象存储读取数据时， Cloud Volumes ONTAP 会将数据移至 SSD/HDD 以提高性能。如果空间不足，则 Cloud Volumes ONTAP 无法移动数据。在更改比率时，请考虑这一点，以便满足您的业务需求。

.步骤
. 在 Cloud Manager 控制台的右上角，单击 * 设置 * 图标，然后选择 * 连接器设置 * 。
+
image:screenshot_settings_icon.gif["一个屏幕截图，显示 Cloud Manager 控制台右上角的设置图标。"]

. 在 * 容量 * 下，单击 * 聚合容量阈值 - 数据分层的可用空间比率 * 。
. 根据需要更改可用空间比率，然后单击 * 保存 * 。




== 更改自动分层策略的冷却期

如果您使用 _auto_tiering 策略在 Cloud Volumes ONTAP 卷上启用了数据分层，则可以根据业务需求调整默认冷却期。仅使用 API 支持此操作。

冷却期是指卷中的用户数据在被视为 " 冷 " 并移至对象存储之前必须保持非活动状态的天数。

自动分层策略的默认冷却期为 31 天。您可以按如下所示更改冷却期：

* 9.8 或更高版本： 2 天到 183 天
* 9.7 或更早版本： 2 天到 63 天


.步骤
. 创建卷或修改现有卷时，请在 API 请求中使用 _minimumCoolingDays_ 参数。

